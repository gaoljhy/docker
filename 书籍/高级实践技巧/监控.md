Docker 作为一个构建部署应用的新兴平台，已经渐渐得到了业界的认可，越来越多的应用开始使用 Docker 作为底层的资源抽象平台。但是，不论 Docker 为代表的容器技术多么先进，具有多大优势，稳定性永远是用户最关注的方面。当用户将应用部署在 Docker 平台。上时，希望应用在平台，上能保持良好的状态，确保平稳运行，并且能实时监控到应用运行的异常情况，进而采取相应的应对措施。同时，由于资源有限，用户还希望能够更为精确地限制容器占用的资源。为了实现这一切，就需要实现对 Docker 容器的监控。


虚拟机技术作为云计算时代发展最为成熟的虚拟化技术，已经形成了稳定可靠、多样化的监控工具供用户使用。那么对于从虚拟机迁移到 Docker 或从 Docker 开始接触云计算的用户来说，Docker 平台下的监控又是如何实现的呢？接下来我们就将从容器的监控维度、Docker 容器监控命令和监控：工具这 3 个方面来系统介绍 Docker 容器监控的实践方法。

#### 1. Docker 容器监控维度

对于 Docker 容器，需要进行全面的监控和监测，以便及时了解 Docker 容器的运行情况及资源使用情况，为运维编排提供决策支持。下面将从 Docker 容器所在的主机、启动容器的镜像基础及容器本身这 3 个维度来总结 Docker 容器监控中所涉及的可用的监控指标。
。主机维度

对于 Docker 的容器监控，主要以容器级别的监控指标为主。这里先介绍一些 Docker 主机级别的监控指标，通过这些指标可以从整体上了解一下主机上的容器运行情况。我们可以监控主机的以下相关信息：

❑ 主机的 CPU 情况和使用量

❑ 主机的内存情况和使用量

❑ 主机上的本地镜像情况

❑ 主机上的容器运行情况

2. 镜像维度

作为容器的基础，还需要对主机上的镜像信息进行监控。镜像的相关信息一般为静态信息，可以反映出主机上用于构建容器的镜像的基础情况，以便从底层来掌握和优化主机上的容器。我们可以监控镜像的以下相关信息：

❑ 镜像的基本信息

❑ 镜像与容器的对应关系

❑ 镜像构建的历史信息（层级的依赖信息）

镜像的基本信息可以包括镜像的总数量、ID、名称、版本、大小等。

3. 容器维度

在主机上运行的容器是监控的重中之重。作为应用的直接载体，使用者需要对容器的各类信息进行实时监控，以保证应用的正常运行。Docker 在底层使用了 Linux 内核提供的资源机制- -namespace 和 cgroups，以此来支持容器的运行。通过这些机制，我们可以很方便地获取容器的各项监控指标。

❑ 容器的基本信息

❑ 容器的运行状态

❑ 容器的用量信息

容器的基本信息包括容器的总数量、ID、名称、镜像、启动命令、端口等信息。容器监控时可以依据容器的运行状态，即运行中、暂停、停止及异常退出，来统计各状态的容器的数量，并实时反馈各个容器的运行状态。容器的用量信息则是用户最关心的，也是监控中最为复杂的部分，它可以统计容器的CPU使用率、内存使用量、块设备I/O使用量、网络使用情况等资源的使用情 况。这一部分监控数据大多数都来源于 Cgroup 下面的限制文件，读者可以参考附录 E 来进行更深人的学习。

#### 2. 容器监控命令

Docker 为用户提供了功能强大的命令行工具，可以让用户完成丰富的功能。同时，Docker 为开发人员提供了标准化的 API，通过调用这些 API 可以让开发人员定制自己的应用服务。

在 Docker 的监控中，namespace 和 cgroups 的使用是至关重要的，读者可以参考 3.1 节的内容学 Docker 背后的内核知识。接下来，依据 Docker 所提供的命令行工具，针对其中与监控有关的命令进行解读。在解读中用到的其他命令读者可自行参考 2.2 节的内容。

1. Docker ps 命令

用户通过使用 docker ps 命令，可以查看当前主机上的容器信息，包括容器 ID、镜像名、容器启动执行命令、创建时间、状态、端口信息和容器名。该命令默认只列出当前正在运行的容器的信息，用户可以通过使用-a 参数来列出包括已停止的所有容器的信息。示例如下：
```
docker ps -a
```

一般情况下，docker ps 命令用于查找容器的 ID，以便用户查看特定容器的具体信息，后续的其他容器监控信息查看命令将普遍用到它。

2. Docker images 命令

用户通过使用 docker images 命令，可以查看当前主机上的镜像信息，包括镜像所属的库、标签、ID、创建时间和实际大小。该命令默认只会列出所有顶层镜像的信息，但用户可以通过-a 参数来查看所有中间层的镜像的信息。示例如下：
```
docker images
```
3. Docker stats 命令

docker stats 命令是 Docker1.5 版本中最新提供的命令，专门用于容器状态信息的统计，同时它还有配套的 API (GET /containers/(id)/stats），可供开发人员调用。使用该命令, 用户可以 实时监控启动中的容器的运行情况,包括CPU、内存、块设备I/O和网络I/O，这些信息都会定期刷新以显示最新的运行情况。示例如下：
```
docker stats redis-master redis-slavel redis-slave2
```

开发者可以使用 stats API 将容器的运行状态信息传递到自己构建的应用中，以实现容器的系统监控。

4. Docker inspect 命令

用户通过使用 docker inspect 命令，可以查看镜像或容器的底层详细信息，以此来了解镜像或容器的完整构建信息，包括基础配置、主机配置、网络设置、状态信息等。同时，如果需要查看其特定信息，可以通过-千参数来设定输出格式。示例如下：

```
docker inspect -f  {{ .NetworkSettings.IPAddress) 9bec172.17.0.2
```

5. Docker top 命令

用户通过使用 docker top 命令，可以查看正在运行的容器中的进程的运行情况。该命令可以 使用户在没有通过/bin/bash终端与容器进行交互时,帮助用户户査看容器内的进程信息，包括进程号、父进程号、命令等。示例如下：

```
docker top 9bec
```


6. Docker port 命令

docker port 命令的用途较为特定化，用于查看容器与主机之间的端口映射关系信息。示例如下：
```
docker ps
docker port bc0a
docker port bc0a 6301/tcp
```

#### 3. 常用的容器监控工具

在了解了 Docker 容器监控的指标及 Docker 命令行工具中与容器监控相关的命令用法后，我们将对当前已有的系统级容器监控工具进行概要介绍。这些监控工具有的是随着 Dockerl 的崛起而发展起来的新兴项目，有的是监控领域发展成熟的优秀项目，各具特色，各有所长。它们为用户提供全面的监控功能，这无疑将为用户的实际容器监控提供极大便利。读者可在了解这些工具后，自行尝试使用，甚至可以在这些项目的基础上加以利用和改进，构建自己的容器监控工具。

1. Google 的 cAdvisor

cAdvisor (Container Advisor）是 Google 开发的用于分析运行中容器的资源占用和性能指标的开源工具。cAdvisor 是一个运行时的守护进程，负责收集、聚合、处理和输出运行中容器的信息。需要特别说明的是，对于每个容器，Cadvisor 都有资源隔离参数、资源使用历史情况以及完整的历史资源使用和网络统计信息的柱状图。cadvisorr 中的数据可以以容器或主机级别进行输出。

cAdvisor 原生支持 Google 自家的 mct 容器，即 Let Me Contain That For You 项目。Imctfy 是Google 开源版本的容器栈，旨在代替 LXC 的 Linux 应用容器，以满足与资源隔离相关的需求。cAdvisor 在 2014 年的 DockerCon 上发布，除了 lmctfy 容器外，同样支持 Docker 的还有 libcontainer 容器。同时，由于采用 Go 语言开发，cAdvisor 可以方便地集成进 libcontainer，它是除了 Kubernetes 外，Google 支持 Docker 的另一个重要应用。

cAdvisor 提供了一个 Docker 镜像，可以供用户在 Docker 中快速运行 cAdvisor，操作简单方便。示例如下：
```
sudo docker run \
--volume=/:/rootfs: ro \
--volume=/var/run:/var/run:rw \
--volume=/sys:/sys:ro \
--volume=/var/lib/docker/:/var/lib/docker:ro \
--publish=8080:8080 \
--detach=true \
--name=cadvisor \
google/cadvisor:latest
```
在启动 cAdvisor 后，它会在后台运行，并暴露 8080 端口，用户可以访问 ttp: //localhost:8080 来查看 cAdvisor。cAdvisor 通过良好交互的 Web UI 提供给用户可视化的数据展示，其访问页面如图 4-17 和图 4-18 所示。



cAdvisor 不但可以自行为用户提供监控服务，还可以结合其他应用为用户提供良好的服务移植和定制。cAdvisor 支持输出状态信息到 InfluxDB 数据库进行存储和读取。同时，它还支持将容器的统计信息以Prometheus标准指标形式输出，并存储在指定的/metrics HTTP 服务端点，以便可以通过 Prometheus 应用来查看 cAdvisor。关于 Prometheus 应用的内容将稍后讲解。此外，对于使用集群的用户，Google 的 Heapster 可以利用 cAdvisor 来监控集群。



图 4-18 cAdvisor 访问页面-资源使用情况

cAdvisor 作为一个开源应用，还为用户提供了丰富的 API 接口服务 cAdvisor Remote REST API，以便为用户提供原始和已处理的统计数据。通过这一套 API，用户可以将 cAdvisor 提供的服务集成进自己的应用中，并扩展监控功能。

cAdvisor 作为一个监控应用，其最终目标在于改善运行中的容器的资源使用和性能表现情况，通过有效的监控，可以实现以下蓝图：

❑ 容器运行报告，包括容器的性能和资源使用情况；

❑ 依据报告，实现容器运行的自动调节；

❑ 为运维编排提供集群的资源使用预测。

目前 cAdvisor 已经在诸多平台得到了应用，依靠其开源特性和 Google 的社区资源正在不断完善和丰富，并朝着其设计蓝图稳步前行。

2. Datadog

Datadog 公司是一家初创企业，其主营业务是帮助其他公司管理和监测云端应用。Datadog 能够帮助开发和运营团队监测其应用在云端工作时的各项数据指标，并提供功能丰富的控制平台，支持多种主流云服务，从而实现云服务的一-站式管理。从 2010 年成立至今，Datadog 已经支持包括亚马逊 AWS、微软 Azure、Google 云平台等主流云服务提供商。Docker 作为当下火热的新型平台，Datadog 也迅速做出支持，实现了对 Docker 的监控集成。

Datadog 利用 Docker 所使用的内核结构 cgroups 获取 Docker 的性能指标，包括 CPU、内存、网 络和I/O数据。Datadog 可以监测和查看所有 Docker 可用的细化性能指标，如图 4-19 所示，具体可以查看 Docker 官网中的 Docker's Runtime Metrics guide。



图 4-19 Datadog 监测 Docker

Datadog 利用 Docker 自身的属性转化成分类标签，以实现对容器监控的聚合整理。通过标签的设定，可以实现复杂的条件筛选，按用户需求来创建容器的监控视图。此外，Datadog 还支持警报功能，可以在发生异常时第- ~时间向用户发送提醒。同样地，警报的设定可以结合标签来使用，便捷地设定多重警报。Datadog 还支持对于容器的生命周期监控，实现了容器整个生命周期中创建、启动、停止和删除事件的可视化管理。

3. SoundCloud 的 Prometheus

SoundCloud 公司的 Prometheus 是一个开源服务监控系统和时间序列数据库。它可以从配置好的监控对象处按照指定的时间间隔来收集信息指标，进行可视化展示和高效的数据存储，并提供警报功能。Prometheus 的优势在于使用高维度的数据模型，以指标名和键值对来定义时间序列。同时，它支持灵活的查询语言，可以对收集的多维度时间序列数据进行处理、绘制图表和设定警报。得益于多维度数据模型基础，Prometheus 可以方便地利用查询语言来进行数据的过滤和聚合。

在使用 Prometheus 时，一般结合 container-exporter 使用，它可以收集以 libcontainer 为执行驱动的容器的各类性能指标，并将数据提供给 Prometheus 使用，如图 4-20 所示。在 Prometheus 的配置中添加 container-exporter 后，即可定期轮询获取性能数据。


图 4-20 Prometheus 使用界面









